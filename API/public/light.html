<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Green House - Ánh sáng</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <!-- Common Components -->
    <script src="components/common.js"></script>
    <script>
      $(document).ready(function() {
        loadHeader('components/header.html', 'Smart Green House - Ánh sáng');
      });
    </script>
  </head>
  <body>
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1><i class="fas fa-sun"></i> Quản lý ánh sáng</h1>
        <p class="subtitle">Theo dõi và điều khiển ánh sáng trong nhà kính</p>
      </div>
      
      <!-- Dashboard Cards -->
      <div class="dashboard-cards">
        <!-- Light Intensity Card -->
        <div class="card" id="light-intensity-card">
          <div class="card-header">
            <h3 class="card-title">Cường độ ánh sáng hiện tại</h3>
            <div class="card-icon">
              <i class="fas fa-sun"></i>
            </div>
          </div>
          <div class="card-value" id="light-intensity">--</div>
          <div class="card-info">lux</div>
          <div class="card-info">
            <small id="last-updated">Cập nhật lần cuối: --</small>
          </div>
        </div>
        
        <!-- Light Status Card -->
        <div class="card" id="light-status-card">
          <div class="card-header">
            <h3 class="card-title">Trạng thái đèn</h3>
            <div class="card-icon">
              <i class="fas fa-lightbulb"></i>
            </div>
          </div>
          


          <div class="card-status">
            <span class="status-indicator" id="light-status">Đang kiểm tra...</span>
          </div>
          <div class="card-info">
            <p>Ánh sáng dưới <span class="threshold-value" id="display-light-threshold">3000</span> lux: tự động BẬT đèn</p>
            <p>Ánh sáng trên <span class="threshold-value" id="display-light-threshold-upper">3000</span> lux: tự động TẮT đèn</p>
          </div>
          <div class="device-controls">
            <button class="control-btn btn-toggle-light">Bật/Tắt đèn</button>
          </div>
        </div>
        
        <!-- Curtain Status Card -->
        <div class="card" id="curtain-status-card">
          <div class="card-header">
            <h3 class="card-title">Trạng thái rèm</h3>
            <div class="card-icon">
              <i class="fas fa-blinds"></i>
            </div>
          </div>
          

          <div class="curtain-status">
            <span class="status-indicator" id="curtain-status">Đang kiểm tra...</span>
          </div>
          <div class="card-info">
            <p>Ánh sáng trên <span class="threshold-value" id="display-curtain-threshold">9999</span> lux: tự động ĐÓNG rèm</p>
            <p>Ánh sáng dưới <span class="threshold-value" id="display-curtain-threshold-lower">9999</span> lux: tự động MỞ rèm</p>
          </div>
          <div class="device-controls">
            <button class="control-btn btn-toggle-curtain">Đóng/Mở rèm</button>
          </div>
        </div>
        
        <!-- Light Settings Card -->
        <div class="card" id="settings-card">
          <div class="card-header">
            <h3 class="card-title">Cài đặt ánh sáng</h3>
            <div class="card-icon">
              <i class="fas fa-sliders-h"></i>
            </div>
          </div>
          <div class="settings-form">
            <div class="form-group">
              <label>Ngưỡng tự động bật đèn (lux):</label>
              <input type="range" id="light-threshold" min="100" max="1000" step="50" value="300">
              <span id="light-threshold-value">300 lux</span>
            </div>
            <div class="form-group">
              <label>Ngưỡng tự động đóng rèm (lux):</label>
              <input type="range" id="curtain-threshold" min="500" max="5000" step="100" value="1000">
              <span id="curtain-threshold-value">1000 lux</span>
            </div>
            <div class="form-group">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="auto-control" checked>
                <label for="auto-control">Kích hoạt điều khiển tự động</label>
              </div>
            </div>
            <button id="save-settings" class="control-btn"><i class="fas fa-save"></i> Lưu cài đặt</button>
          </div>
        </div>
      </div>
      
      <!-- Chart Container -->
      <div class="card" id="chart-card">
        <div class="card-header">
          <h3 class="card-title">Biểu đồ cường độ ánh sáng</h3>
          <div class="card-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="chart-controls">
          <button id="toggleChart" class="btn-chart-control">
            <i class="fas fa-eye"></i> <span id="toggleChartText">Ẩn biểu đồ</span>
          </button>
          <select id="dataPointsLimit" class="chart-select">
            <option value="10">10 điểm dữ liệu</option>
            <option value="20" selected>20 điểm dữ liệu</option>
            <option value="30">30 điểm dữ liệu</option>
            <option value="50">50 điểm dữ liệu</option>
          </select>
          <select id="timeRange" class="chart-select">
            <option value="day">Hôm nay</option>
            <option value="week">Tuần này</option>
            <option value="month">Tháng này</option>
          </select>

          <button id="batden">Bật đèn</button>
<button id="tatden">Tắt đèn</button>
        </div>
        <div id="chartContainer">
          <canvas id="lightChart"></canvas>
        </div>
      </div>
    </div>


    <!-- Load module specific scripts -->
    <script src="js/light-module.js"></script>
  </body>
</html>

<script>
  // MQTT client instance
  let client;

  $(document).ready(function () {
    // Create a client instance
    client = new Paho.MQTT.Client("SmartGreenHouse", 8083, "mqttx_470f24bd");
    
    // Set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    
    // Connect to the broker
    client.connect({
      onSuccess: onConnect,
      useSSL: true,
      userName: "admin",
      password: "123456",
      timeout: 3,
      onFailure: function(e) {
        console.error("Connection failed: ", e);
      }
    });

    // Button event handlers
    $('#batden').click(function() {
      sendMessage("on");
    });

    $('#tatden').click(function() {
      sendMessage("off");
    });
  });

  function sendMessage(content) {
    if (client.isConnected()) {
      const message = new Paho.MQTT.Message(content);
      message.destinationName = "myapp/greenhouse";
      client.send(message);
      console.log("Sent message: " + content);
    } else {
      console.error("MQTT client not connected!");
    }
  }

  function onConnect() {
    console.log("Connected to MQTT broker");
    client.subscribe("myapp/greenhouse");
  }

  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("Connection lost: " + responseObject.errorMessage);
    }
  }

  function onMessageArrived(message) {
    console.log("Message received: " + message.payloadString);
  }
</script>
